# Spack environment file for an MPI parallel CP2K binary with all available dependencies

# Edit this file with care because it is automatically changed by the make_cp2k.sh script

spack:
  concretizer:
    unify: true

  config:
    install_tree:
      padded_length: 128
      root: /opt/spack

  modules:
    prefix_inspections:
      bin:
        - PATH
      lib:
        - LD_LIBRARY_PATH
      lib64:
        - LD_LIBRARY_PATH

  packages:
    all:
      buildable: true
      prefer:
        - "~cuda"
        - "+mpi"
        - "+mpi_f08"
        - "+openmp"
        - "+pic"
        - "~rocm"
        - "build_system=cmake"
        - "build_type=Release"

    cuda:
      buildable: false
      externals:
        - spec: cuda@12.9
          prefix: /usr/local/cuda

    # Build tools
    mpi:
      require:
        - mpich

    mpich:
      require:
        - "~xpmem"
#       - "netmod=ofi"

    xpmem:
      require:
        - "xpmem@master ~kernel-module"

    # ScaLAPACK, LAPACK, BLAS
    blas:
      require:
        - openblas

    lapack:
      require:
        - openblas

    libxsmm:
      require:
        - "blas=default"

    openblas:
      require:
        - "+fortran"
        - "threads=openmp"
        - "build_system=makefile"

    scalapack:
      require:
        - netlib-scalapack

    # Libraries needed by CP2K
    adios2:
      require:
        - "~bzip2"

    cosma:
      require:
        - "+scalapack"

    dbcsr:
      require:
        - "~examples"
        - "+openmp"
        - "smm=libxsmm"

    deepmdkit:
      require:
        - "+pytorch"

    dla-future:
      require:
        - "+scalapack"

    elpa:
      require:
        - "+openmp"

    fftw:
      require:
        - "+openmp"

    hdf5:
      require:
        - "+fortran"

    libfabric:
      require:
        - "~cuda"
#       - "+gdrcopy"
#       - "fabrics=cxi"

    libint:
      require:
        - "+fortran"
        - "tune=cp2k-lmax-5"

    libxc:
      require:
        - "~cuda"
        - "+kxc"

    mctc-lib:
      require:
        - "~openmp"

    openpmd-api:
      require:
        - "+adios2"

    pexsi:
      require:
        - "+fortran"

    py-torch:
      require:
        - "~cuda"
        - "~distributed"
        - "~kineto"
        - "~mkldnn"
        - "~rocm"
        - "~valgrind"

    sirius:
      require:
        - "~apps"
        - "+dftd3"
        - "+dlaf"
        - "+elpa"
        - "+fortran"
        - "+pugixml"
        - "+scalapack"
        - "+vdwxc"

    spla:
      require:
        - "+fortran"

    trexio:
      require:
        - "+hdf5"

  repos:
    builtin:
      commit: 89e70e65e55b27552f6ac07df2970e62adb9b3e2 # 2026-02-13

  specs:
    # Build tools
    - "cmake@3.27:"
    - "gcc@10:"
    - "gmake@4.2:"
    - "mpich@4.3.2"
    - "ninja@1.13"
#   - "openmpi@5.0.9"
    - "python@3.11:"
    # CP2K
    - "adios2@2.11.0"
    - "cosma@2.7.0"
    - "dbcsr@2.9.1"
    - "deepmdkit@3.1.2"
    - "dftd4@3.7.0"
    - "dla-future@0.10.0"
    - "dla-future-fortran@0.5.0"
    - "elpa@2025.06.001"
    - "fftw@3.3.10"
    - "greenx@2.2"
    - "hdf5@1.14.6"
    - "libfabric@2.4.0"
    - "libint@2.11.2"
    - "libsmeagol@1.2"
    - "libvdwxc@0.5.0"
    - "libvori@220621"
    - "libxc@7.0.0"
    - "libxsmm@1.17-cp2k"
    - "mimic-mcl@3.0.0"
    - "netlib-scalapack@2.2.2"
    - "openblas@0.3.31"
    - "openpmd-api@0.17.0"
    - "pace@2025.12.4"
    - "pexsi@2.0.0"
    - "plumed@2.10.0"
    - "py-torch@2.9.0"
    - "sirius@7.10.0"
    - "spfft@1.1.1"
    - "spglib@2.7.0"
    - "spla@1.6.1"
    - "tblite@0.5.0"
    - "trexio@2.5.0"

  view:
    default:
      root: /opt/spack/view
      exclude:
        # Exclude gcc-runtime to avoid adding a copy of libgomp.so to the view
        - gcc-runtime
